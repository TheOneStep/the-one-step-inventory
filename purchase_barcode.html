<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ë§¤ì… ë°”ì½”ë“œ ë“±ë¡</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background:#eef4ff; /* ë§¤ì…: ì—°í•œ íŒŒë‘ */
  margin:0;
  padding:20px;
  text-align:center;
}
.page-container {
  max-width:420px;
  margin:0 auto;
  padding:0 16px 24px;
  background:#eef4ff; /* ë§¤ì… ë°•ìŠ¤ */
}
h1 {
  font-size:20px;
  margin:8px 0 16px;
}
.field { margin-bottom:12px; }
.field label {
  display:block;
  font-size:13px;
  margin-bottom:6px;
  color:#333;
}
.field input,
.field textarea {
  width:100%;
  padding:10px;
  font-size:15px;
  box-sizing:border-box;
  text-align:center;
}
.field input[readonly] { background:#f5f5f5; }
textarea { resize:vertical; min-height:60px; }

.btn-wrap {
  display:flex;
  justify-content:center;
  margin-top:12px;
}
.ios-pill-btn {
  appearance:none;
  background:#007aff;
  color:#000;
  border:none;
  border-radius:999px;
  width:100%;
  padding:10px 22px;
  font-size:17px;
  font-weight:500;
  cursor:pointer;
}
.ios-pill-btn:active { background:#005ecb; }

.btn {
  width:100%;
  padding:12px;
  font-size:16px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  margin-top:10px;
}
.btn-gray {
  background:#f3f3f3;
  border:1px solid #ccc;
}
.btn-blue {
  background:#007aff;
  color:#fff;
}

#product-form {
  display:block;
  margin-top:16px;
  padding-top:12px;
  border-top:1px solid #eee;
}

#cart-list {
  margin:12px 0;
  padding:10px;
  border:1px solid #ddd;
  border-radius:8px;
  font-size:14px;
  text-align:left;
  background:#fff;
}
#cart-list .row {
  padding:10px 0;
  border-bottom:1px dashed #eee;
}
#cart-list .row:last-child { border-bottom:none; }
#cart-list .title { font-weight:700; }
#cart-list .meta { color:#666; font-size:12px; }

.total-box {
  margin:10px 0;
  font-size:16px;
  font-weight:700;
}
/* =========================
   ì…ë ¥ í•„ë“œ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ë§¤ì…)
   ========================= */
.field input,
.field textarea {
  background: #ffffff;          /* í° ì¹´ë“œ */
  border: 1px solid #e2e2e2;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}

/* ì½ê¸° ì „ìš© í•„ë“œëŠ” ì‚´ì§ í†¤ ë‹¤ìš´ */
.field input[readonly] {
  background: #f7f7f7;
  box-shadow: none;
}
#cart-list .row {
  position: relative;
  cursor: pointer;
}

#cart-list .row:hover {
  background: #f6f9ff;
}

.del-x {
  position: absolute;
  top: 6px;
  right: 8px;
  font-size: 18px;
  color: #999;
  cursor: pointer;
}

.del-x:hover {
  color: #ff3b30;
}
</style>
</head>

<body>
<div class="page-container">
  <h1>ë§¤ì… ë°”ì½”ë“œ ë“±ë¡</h1>

  <div class="field">
    <label>ë§¤ì…ì¼ì</label>
    <input type="date" id="purchaseDate">
  </div>

  <div class="btn-wrap">
    <button id="btnStart" class="ios-pill-btn">ìŠ¤ìº” ì‹œì‘</button>
  </div>

  <div style="margin-top:12px;">
    ì¸ì‹ ê²°ê³¼: <span id="barcode-value">ì—†ìŒ</span>
  </div>

  <div id="scan-wrapper" style="display:none; margin-top:12px; position:relative; text-align:center;">
    <div
      id="reader"
      style="
        width:100%;
        max-width:420px;
        height:320px;
        background:#000;
        border-radius:12px;
        overflow:hidden;
        margin:0 auto;
      "
    ></div>
    <div id="scan-sector"
      style="position:absolute;top:55%;left:50%;width:240px;height:120px;
      transform:translate(-50%,-50%);border:2px solid #00ff88;"></div>
  </div>

  <div id="product-form">

    <div class="field">
      <label>ë°”ì½”ë“œ</label>
      <input
        id="input-barcode"
        placeholder="ë°”ì½”ë“œ ì§ì ‘ ì…ë ¥ ê°€ëŠ¥"
        inputmode="numeric"
      >
    </div>

    <div class="field">
      <label>ìƒí’ˆ ì´ë¯¸ì§€</label>

      <input
        type="file"
        id="input-image"
        accept="image/*"
        capture="environment"
        style="display:none;"
      >

      <button
        type="button"
        class="btn btn-gray"
        id="btn-image"
      >
        ğŸ“· ìƒí’ˆ ì‚¬ì§„ ì°ê¸°
      </button>

      <div style="margin-top:8px;">
        <img
          id="image-preview"
          style="max-width:100%; border-radius:10px; display:none;"
        >
      </div>
    </div>

    <div class="field">
      <label>ìƒí’ˆëª…</label>
      <input id="input-name" autocomplete="off">
      <div id="name-suggest"
        style="
          display:none;
          background:#fff;
          border:1px solid #ddd;
          border-radius:8px;
          margin-top:4px;
          max-height:160px;
          overflow-y:auto;
          text-align:left;
          font-size:14px;
        ">
      </div>
    </div>

    <div class="field">
      <label>ê°€ê²©</label>
      <input id="price" inputmode="numeric">
    </div>

    <div class="field">
      <label>ìˆ˜ëŸ‰</label>
      <input id="qty" inputmode="numeric">
    </div>

    <div class="field">
      <label>ë©”ëª¨</label>
      <textarea id="memo"></textarea>
    </div>

    <button id="btnAddToCart" class="btn btn-gray">ì¶”ê°€</button>

    <div id="cart-list"></div>

    <div class="field">
      <label>ì´ì•¡</label>
      <input id="total-amount" value="0" readonly>
    </div>

    <button id="btnSaveAll" class="btn btn-blue">ì „ì²´ ë“±ë¡</button>
  </div>
</div>

<script src="static/js/product_master.js"></script>

<script>
function getAllProducts() {
  const map = new Map();

  // ìƒí’ˆ ë§ˆìŠ¤í„°
  if (window.ProductMaster?.getAll) {
    const all = ProductMaster.getAll();
    for (const bc in all) {
      if (all[bc]?.name) {
        map.set(all[bc].name, bc);
      }
    }
  }

  // ê¸°ì¡´ ë§¤ì…
  const purchases = JSON.parse(localStorage.getItem("purchase_list") || "[]");
  purchases.forEach(p => {
    if (p.name && p.barcode) map.set(p.name, p.barcode);
  });

  // ê¸°ì¡´ ë‚©í’ˆ
  const sales = JSON.parse(localStorage.getItem("sales_list") || "[]");
  sales.forEach(s => {
    if (s.productName && s.barcode) {
      map.set(s.productName, s.barcode);
    }
  });

  return Array.from(map.entries()); // [ [name, barcode] ]
}
</script>

<script>
// âœ… ìˆ˜ì •ëª¨ë“œ ìƒíƒœ
let editingTempId = null;

function parseNumber(v){

  return Number(String(v||"").replace(/,/g,""))||0;
}
function formatNumber(v){
  return (Number(v)||0).toLocaleString("ko-KR");
}
function rand6(){
  return Math.random().toString(36).slice(2,8);
}

const dateEl = document.getElementById("purchaseDate");
const barcodeSpan = document.getElementById("barcode-value");
const formEl = document.getElementById("product-form");

const barcodeEl = document.getElementById("input-barcode");
const nameEl = document.getElementById("input-name");
const suggestBox = document.getElementById("name-suggest");

const priceEl = document.getElementById("price");
const qtyEl = document.getElementById("qty");
const memoEl = document.getElementById("memo");

// =======================
// ğŸ“· ìƒí’ˆ ì´ë¯¸ì§€ ì²˜ë¦¬
// =======================
let currentImageBase64 = null;

const imgInput = document.getElementById("input-image");
const imgBtn = document.getElementById("btn-image");
const imgPreview = document.getElementById("image-preview");

imgBtn.addEventListener("click", () => {
  imgInput.click();
});

imgInput.addEventListener("change", () => {
  const file = imgInput.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    currentImageBase64 = reader.result;
    imgPreview.src = currentImageBase64;
    imgPreview.style.display = "block";
  };
  reader.readAsDataURL(file);
});

nameEl.addEventListener("input", () => {
  const keyword = nameEl.value.trim();
  if (keyword.length < 2) {
    suggestBox.style.display = "none";
    return;
  }

  const list = getAllProducts();
  const matches = list.filter(([name]) => name.includes(keyword));

  if (!matches.length) {
    suggestBox.style.display = "none";
    return;
  }

  suggestBox.innerHTML = matches.map(([name, bc]) => `
    <div style="padding:8px 10px; cursor:pointer;"
         data-name="${name}"
         data-barcode="${bc}">
      ${name}
    </div>
  `).join("");

  suggestBox.style.display = "block";
});

suggestBox.addEventListener("click", (e) => {
  const item = e.target.closest("[data-barcode]");
  if (!item) return;

  nameEl.value = item.dataset.name;
  barcodeEl.value = item.dataset.barcode;

  suggestBox.style.display = "none";

  if (window.ProductMaster) {
    const m = ProductMaster.get(barcodeEl.value);
    if (m?.price) {
      priceEl.value = formatNumber(m.price);
    }
  }
});

const cartBox = document.getElementById("cart-list");
const totalEl = document.getElementById("total-amount");

const btnAdd = document.getElementById("btnAddToCart");
const btnSaveAll = document.getElementById("btnSaveAll");

(function setToday(){
  dateEl.value = new Date().toLocaleDateString("sv-SE");
})();

[priceEl, qtyEl].forEach(el=>{
  el.addEventListener("blur",()=>{
    const v=parseNumber(el.value);
    el.value=v?formatNumber(v):"";
  });
});

function updateTempTotal() {
  // ì¥ë°”êµ¬ë‹ˆì— í•­ëª©ì´ ìˆìœ¼ë©´ ê¸°ì¡´ ì´ì•¡ ìœ ì§€
  if (purchaseCart.items.length > 0) return;

  const price = parseNumber(priceEl.value);
  const qty   = parseNumber(qtyEl.value);

  const total = price * qty;
  totalEl.value = total ? formatNumber(total) : "0";
}

// ì…ë ¥ ì¤‘ ì‹¤ì‹œê°„ ê³„ì‚°
priceEl.addEventListener("input", updateTempTotal);
qtyEl.addEventListener("input", updateTempTotal);

const CART_KEY="purchase_cart_tmp";
const purchaseCart={
  items:[],
  load(){
    try{ this.items=JSON.parse(localStorage.getItem(CART_KEY)||"[]"); }
    catch(e){ this.items=[]; }
  },
  save(){ localStorage.setItem(CART_KEY,JSON.stringify(this.items)); },
  add(it){
  // âœ… ê°™ì€ ìƒí’ˆ íŒë³„ ê¸°ì¤€ (ê¸°ë³¸: ë°”ì½”ë“œ + ê°€ê²©)
  //    - ë°”ì½”ë“œë§Œìœ¼ë¡œ í•©ì¹˜ê³  ì‹¶ìœ¼ë©´ (x.barcode === it.barcode)ë§Œ ë‚¨ê¸°ë©´ ë¨
  const idx = this.items.findIndex(x => x.barcode === it.barcode);

  if (idx >= 0) {
    // âœ… ì´ë¯¸ ìˆìœ¼ë©´ ìˆ˜ëŸ‰ë§Œ í•©ì‚°
    this.items[idx].qty = (Number(this.items[idx].qty) || 0) + (Number(it.qty) || 0);

    // âœ… ì´ë¦„ì´ ë¹„ì–´ìˆë˜ ê²½ìš°ë§Œ ì±„ì›€(ì•ˆì „)
    if (!this.items[idx].name && it.name) {
      this.items[idx].name = it.name;
    }

    // âœ… ë©”ëª¨ëŠ” ì„ íƒ: ë‘˜ ë‹¤ ìˆìœ¼ë©´ ì¤„ë°”ê¿ˆìœ¼ë¡œ í•©ì¹¨
    if (it.memo) {
      const prev = (this.items[idx].memo || "").trim();
      this.items[idx].memo = prev ? (prev + "\\n" + it.memo) : it.memo;
    }
  } else {
    // âœ… ì—†ìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€
    this.items.push(it);
  }

  this.save();
  this.render();
},
  clear(){
    this.items=[];
    this.save();
    this.render();
  },
  render(){
  if(!this.items.length){
    cartBox.innerHTML="<div class='meta'>ì•„ì§ ì¶”ê°€ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
    totalEl.value = "0";
    return;
  }

  let html="", total=0;

  this.items.forEach((it,idx)=>{
    // âœ… tempId ì—†ë˜ ê¸°ì¡´ ë°ì´í„°ë„ ìë™ ë³´ì •
    if(!it.tempId) it.tempId = "p_tmp_" + Date.now() + "_" + rand6();

    const amt=(it.price||0)*(it.qty||0);
    total+=amt;

    const memoSafe = String(it.memo||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;")
      .replaceAll("\n","<br>");

    html+=`
        <div class="row" data-tempid="${it.tempId}">
          <span class="del-x" data-action="del">Ã—</span>

          <div class="title">${idx+1}. ${it.name} (${it.barcode})</div>
          <div class="meta">
            ê°€ê²© ${formatNumber(it.price)} |
            ìˆ˜ëŸ‰ ${formatNumber(it.qty)} |
            ê¸ˆì•¡ ${formatNumber(amt)}
          </div>
          ${it.memo ? `<div class="meta">ë©”ëª¨: ${memoSafe}</div>` : ""}
        </div>
      </div>
    `;
  });

  cartBox.innerHTML=html;
  totalEl.value = formatNumber(total);
}
};
purchaseCart.load();
purchaseCart.render();

// âœ… ì¥ë°”êµ¬ë‹ˆ ìˆ˜ì •/ì‚­ì œ ì´ë²¤íŠ¸ (ì „ì—­í•¨ìˆ˜ í•„ìš” ì—†ìŒ)
cartBox.addEventListener("click", (e) => {

  // âŒ ì‚­ì œ(X) í´ë¦­
  const delBtn = e.target.closest(".del-x");
  if (delBtn) {
    e.stopPropagation(); // row í´ë¦­ ë°©ì§€

    const row = delBtn.closest(".row");
    const tempId = row.getAttribute("data-tempid");

    if (!confirm("ì´ í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?")) return;

    purchaseCart.items = purchaseCart.items.filter(x => x.tempId !== tempId);
    purchaseCart.save();
    purchaseCart.render();

    if (editingTempId === tempId) editingTempId = null;
    return;
  }

  // âœï¸ row í´ë¦­ â†’ ìˆ˜ì •
  const row = e.target.closest(".row");
  if (!row) return;

  const tempId = row.getAttribute("data-tempid");
  const it = purchaseCart.items.find(x => x.tempId === tempId);
  if (!it) return;

  editingTempId = tempId;

  barcodeEl.value = it.barcode || "";
  nameEl.value = it.name || "";
  priceEl.value = it.price ? formatNumber(it.price) : "";
  qtyEl.value = it.qty ? formatNumber(it.qty) : "";
  memoEl.value = it.memo || "";

  formEl.style.display = "block";
});

const observer=new MutationObserver(()=>{
  const code=barcodeSpan.textContent.trim();
  if(!code||code==="ì—†ìŒ") return;
  barcodeEl.value=code;
  formEl.style.display="block";

  if(window.ProductMaster){
    const m=ProductMaster.get(code);
    if(m){
      if(!nameEl.value) nameEl.value=m.name||"";
      if(!priceEl.value && m.price) priceEl.value=formatNumber(m.price);
    }
  }
});
observer.observe(barcodeSpan,{childList:true});

btnAdd.addEventListener("click", () => {
  const item = {
    // âœ… ìˆ˜ì • ì¤‘ì´ë©´ ê¸°ì¡´ tempId ìœ ì§€, ì•„ë‹ˆë©´ ì‹ ê·œ ìƒì„±
    tempId: editingTempId || ("p_tmp_" + Date.now() + "_" + rand6()),
    barcode: barcodeEl.value.trim(),
    name: nameEl.value.trim(),
    price: parseNumber(priceEl.value),
    qty: parseNumber(qtyEl.value),
    memo: memoEl.value.trim(),
    image: currentImageBase64   // âœ… ì¶”ê°€
  };

  if (!item.barcode || !item.name) { alert("ë°”ì½”ë“œì™€ ìƒí’ˆëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); return; }
  if (item.qty <= 0) { alert("ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤."); return; }

  // âœ… ìˆ˜ì •ì´ë©´ êµì²´, ì‹ ê·œë©´ ê¸°ì¡´ add ë¡œì§ ì‚¬ìš©(ë™ì¼ ë°”ì½”ë“œ í•©ì‚° ê·œì¹™ ìœ ì§€)
  if (editingTempId) {
    const idx = purchaseCart.items.findIndex(x => x.tempId === editingTempId);
    if (idx >= 0) {
      purchaseCart.items[idx] = item;
      purchaseCart.save();
      purchaseCart.render();
    } else {
      // í˜¹ì‹œ ëª» ì°¾ìœ¼ë©´ ì‹ ê·œë¡œ
      purchaseCart.add(item);
    }
  } else {
    purchaseCart.add(item);
  }

  if (window.ProductMaster) {
    ProductMaster.set(item.barcode, { name: item.name, price: item.price });
  }

  // âœ… ì…ë ¥ ì´ˆê¸°í™” + ìˆ˜ì •ëª¨ë“œ ì¢…ë£Œ
  editingTempId = null;

  barcodeEl.value = "";
  nameEl.value = "";
  priceEl.value = "";
  qtyEl.value = "";
  memoEl.value = "";
  barcodeSpan.textContent = "ì—†ìŒ";

  /* â¬‡â¬‡â¬‡ ì—¬ê¸° ë°”ë¡œ ì¶”ê°€ â¬‡â¬‡â¬‡ */
  currentImageBase64 = null;
  imgPreview.style.display = "none";
  imgInput.value = "";
});

btnSaveAll.addEventListener("click",()=>{
  if(!purchaseCart.items.length){
    alert("ë“±ë¡í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  const list=JSON.parse(localStorage.getItem("purchase_list")||"[]");
  purchaseCart.items.forEach(it=>{
    list.push({
      id:"p_"+Date.now()+"_"+rand6(),
      purchaseDate:dateEl.value,
      barcode:it.barcode,
      name:it.name,
      price:it.price,
      qty:it.qty,
      memo:it.memo,
      image: it.image || null,   // âœ… ì¶”ê°€
      createdAt:new Date().toISOString()
    });
  });
  localStorage.setItem("purchase_list",JSON.stringify(list));
  purchaseCart.clear();
  alert("ë§¤ì…ì´ ëª¨ë‘ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
  location.href = "purchase_list.html";
});

</script>

<script>
// Detect iOS devices (iPhone, iPad) including Safari on Mac with touch support.
const ua = navigator.userAgent;
const isIOS = /iPhone|iPad|iPod/i.test(ua) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

if (isIOS) {
  // On iOS, load the html5-qrcode library and the iOS-specific scanner script.
  const lib = document.createElement("script");
  // Load a version of html5-qrcode that supports barcode scanning (v2.x+).
  lib.src = "https://unpkg.com/html5-qrcode@2.4.0/html5-qrcode.min.js";
  lib.onload = () => {
    const iosScript = document.createElement("script");
    iosScript.src = "static/js/barcode_ios.js?v=" + Date.now();
    iosScript.onload = () => {
      if (window.initBarcodeIOS) {
        window.initBarcodeIOS();
      } else {
        console.error("initBarcodeIOS function is not defined in barcode_ios.js");
      }
    };
    document.body.appendChild(iosScript);
  };
  document.body.appendChild(lib);
} else {
  // On non-iOS devices, load the Android scanner.
  const s = document.createElement("script");
  s.src = "static/js/barcode_android.js?v=" + Date.now();
  s.onload = () => {
    if (window.initBarcodeAndroid) {
      window.initBarcodeAndroid();
    } else {
      console.error("initBarcodeAndroid function is not defined in barcode_android.js");
    }
  };
  document.body.appendChild(s);
}
</script>
</body>
</html>
