<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ê±°ë˜ ëª©ë¡ (ë§¤ì… Â· ë§¤ì¶œ)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* âœ… ë°˜ë“œì‹œ CSS ì œì¼ ìœ„ */
*, *::before, *::after {
  box-sizing: border-box;
}  
* { box-sizing:border-box; }
html, body {
  width: 100%;
  overflow-x: hidden;
}
body {
  margin:0;
  padding:0;
  background:#f6f7f9;
}
.container{
  max-width:420px;
  width:100%;
  margin:0 auto;
  padding:20px;      /* âœ… paddingì€ ì—¬ê¸°ë¡œ */
  overflow-x:hidden;
}
/* ë‚ ì§œ input í­ ê°•ì œ */
input[type="date"]{
  width:100%;
  min-width:0;
  max-width:100%;
}
h3{
  text-align:center;
  margin-bottom:16px;
}
/* ê¸°ê°„ ê²€ìƒ‰ (AdSense ìŠ¤íƒ€ì¼) */
.type-box{
  display:flex;
  gap:5px;                 /* ğŸ”¹ -1px */
  align-items:center;
  padding:9px 0px;         /* ğŸ”¹ ìœ„ì•„ë˜ -1px / ì¢Œìš° -1px */
  border:1px solid #ddd;
  border-radius:9px;       /* ğŸ”¹ ì‚´ì§ ë‘¥ê·¼ ëŠë‚Œ ê°ì†Œ */
  background:#fff;
  box-shadow:0 2px 6px rgba(0,0,0,.05);
  flex:0 0 auto;
}
.range-row{
  display:flex;
  gap:0px;
}
.range-box,
.search-box {
  width:100%;
  max-width:100%;
}
.range-row input{
  flex:1;
  padding:10px;
  font-size:14px;
  border-radius:10px;
  border:1px solid #ddd;
}
.range-actions{
  display:flex;
  gap:6px;
  margin-top:8px;
}
.range-actions button{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
  background:#f3f3f3;
  cursor:pointer;
}

/* ê²€ìƒ‰ ë°•ìŠ¤ */
.search-box{
  background:#fff;
  border-radius:14px;
  padding:12px;
  margin-bottom:14px;
  box-shadow:0 2px 6px rgba(0,0,0,.05);
}
.search-box input{
  width:100%;
  padding:12px;
  font-size:15px;
  border-radius:10px;
  border:1px solid #ddd;
}

/* ì¹´ë“œ */
.card > * {
  margin-bottom: 6px;   /* âœ… ëª¨ë“  ì¤„ ê¸°ë³¸ ê°„ê²© */
  line-height: 1.45;    /* âœ… ëª¨ë°”ì¼ ê°€ë…ì„± ìµœì  */
}
.card .title {
  font-weight: 700;
  font-size: 15px;
  margin-bottom: 6px;
}
.card .barcode,
.card .meta {
  font-size: 13px;
  color: #555;
  margin-bottom: 6px;
}
.card .amount {
  margin-top: 10px;     /* â¬† ìœ„ ì •ë³´ì™€ ê°„ê²© */
  font-weight: 700;
  font-size: 15px;
}
.card .meta:last-child {
  margin-top: 6px;
}
.card .badge {
  margin-bottom: 6px;
}
.card{
  position:relative;
  border-radius:16px;
  padding:14px 14px 16px;
  margin-bottom:12px;
  box-shadow:0 4px 10px rgba(0,0,0,.06);
  font-size:14px;
}
.card .title{ font-weight:700; margin-bottom:4px; }
.card .barcode{ font-size:12px; color:#777; margin-bottom:6px; }
.card .meta{ font-size:13px; color:#555; }
.card .amount{ margin-top:6px; font-weight:700; }

.btn-del{
  position:absolute;
  top:10px;
  right:10px;
  border:none;
  background:transparent;
  font-size:16px;
  cursor:pointer;
  color:#999;
}
.btn-del:hover{ color:#d00; }

.card.purchase{ background:#eef4ff; }
.card.sale{ background:#fff0f0; }

.badge{
  display:inline-block;
  font-size:11px;
  padding:3px 8px;
  border-radius:999px;
  margin-bottom:6px;
}
.badge.purchase{ background:#dbe7ff; color:#2b5fd9; }
.badge.sale{ background:#ffdede; color:#d93b3b; }

/* ì—‘ì…€ ë²„íŠ¼ */
.excel-box{
  text-align:right;
  margin:10px 0 14px;
}
.excel-box button{
  padding:8px 12px;
  font-size:13px;
  border-radius:8px;
  border:1px solid #007aff;
  background:#eef5ff;
  color:#007aff;
  cursor:pointer;
}

.empty{
  text-align:center;
  color:#777;
  margin-top:40px;
}
/* âœ… ë‚ ì§œ ìˆ«ì ê°€ë…ì„± ê°•í™” */
input[type="date"]{
  color: #111;                 /* ìˆ«ì ìƒ‰ìƒ ì§„í•˜ê²Œ */
  font-weight: 600;            /* ìˆ«ì ë‘ê»˜ */
  letter-spacing: 0.3px;       /* ìˆ«ì ê°„ê²© */
  background-color: #fff;
  -webkit-text-fill-color: #111;  /* ì•ˆë“œë¡œì´ë“œ ê°•ì œ íšŒìƒ‰ ë°©ì§€ */
  letter-spacing: 0;   /* âœ… ë°˜ë“œì‹œ 0 */
}

/* ë‚ ì§œ placeholder ëŠë‚Œ ì œê±° */
input[type="date"]::-webkit-datetime-edit {
  color: #111;
  font-weight: 600;
}

/* ë‚ ì§œ ì„¸ë¶€ íŒŒíŠ¸ (ì—°/ì›”/ì¼) */
input[type="date"]::-webkit-datetime-edit-year-field,
input[type="date"]::-webkit-datetime-edit-month-field,
input[type="date"]::-webkit-datetime-edit-day-field {
  color: #111;
  font-weight: 600;
}
/* âœ… ì—‘ì…€ ì¤„ + íƒ€ì… ì„ íƒ ë°•ìŠ¤ (ì‘ê²Œ) */
.excel-row{
  display:flex;
  align-items:center;
  gap:10px;
  margin:10px 0 14px;
}

/* ì™¼ìª½ ì‘ì€ ì‚¬ê° ë°•ìŠ¤ */
.type-box{
  display:flex;
  gap:10px;
  align-items:center;
  padding:8px 10px;
  border:1px solid #ddd;
  border-radius:10px;
  background:#fff;
  box-shadow:0 2px 6px rgba(0,0,0,.05);
  flex:0 0 auto;
}

/* ì²´í¬ í•­ëª© */
.type-item{
  display:flex;
  align-items:center;
  gap:4px;
  font-size:13px;
  color:#333;
  white-space:nowrap;
}

/* ì²´í¬ë°•ìŠ¤ í¬ê¸° ì‚´ì§ë§Œ */
.type-item input{
  width:18px;
  height:18px;
}

/* 
ë²„íŠ¼(ê¸°ì¡´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ê³¼ ë™ì¼ í†¤) */
.excel-btn{
  margin-left:auto;
  padding:6px 10px;
  font-size:11px;
  border-radius:8px;
  border:1px solid #007aff;
  background:#eef5ff;
  color:#007aff;
  cursor:pointer;
}
.action-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin:12px 0 14px;
}

.left-actions{
  display:flex;
  gap:10px;
}

.right-actions{
  display:flex;
  gap:8px;
  align-items:center;
}

/* ì—‘ì…€: ì•„ì´ì½˜ ë²„íŠ¼ */
.icon-btn{
  width:42px;
  height:42px;
  border-radius:10px;
  border:1px solid #007aff;
  background:#eef5ff;
  color:#007aff;
  font-size:18px;
}

/* ì¬ê³  ê´€ë¦¬: í…ìŠ¤íŠ¸ ë²„íŠ¼ */
.text-btn{
  padding:10px 14px;
  border-radius:12px;
  border:1px solid #ddd;
  background:#fff;
  font-size:14px;
  color:#333;
}
/* ğŸ”µ ê²€ìƒ‰ì°½ í…ìŠ¤íŠ¸ ê°€ìš´ë° ì •ë ¬ */
.search-box input{
  text-align: center;
}

/* ğŸ”µ placeholder ê°€ìš´ë° ì •ë ¬ (ë¸Œë¼ìš°ì €ë³„ ëŒ€ì‘) */
.search-box input::placeholder{
  text-align: center;
}

.search-box input::-webkit-input-placeholder{
  text-align: center;
}

.search-box input:-ms-input-placeholder{
  text-align: center;
}
/* ğŸ” ìƒë‹¨ ê³µí†µ ë„¤ë¹„ */
.top-nav{
  display:flex;
  gap:10px;
  margin:12px 0 16px;
}

.nav-btn{
  flex:1;
  padding:12px 0;
  border-radius:999px;
  border:1px solid #d0d7e2;
  background:#ffffff;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
  color:#333;
  box-shadow:0 2px 6px rgba(0,0,0,.05);
}

.nav-btn:hover{
  background:#eef4ff;
}

/* í˜„ì¬ í˜ì´ì§€ í‘œì‹œ */
.nav-btn.active{
  background:#007aff;
  color:#fff;
  border-color:#007aff;
}
.meta .strong{
  font-weight:700;
}
.card.sale .meta strong{
  color:#d93b3b;
}
</style>
</head>
<body>

  <!-- ğŸ” ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
<div class="top-nav">
  <button class="nav-btn" data-link="index.html">
    ğŸ“Š ëŒ€ì‹œë³´ë“œ
  </button>
  <button class="nav-btn" data-link="purchase_list.html">
    ğŸ“‹ ê±°ë˜ ëª©ë¡
  </button>
  <button class="nav-btn" data-link="stock_list.html">
    ğŸ“¦ ì¬ê³  ê´€ë¦¬
  </button>  
</div>
<h3>ê±°ë˜ ëª©ë¡</h3>
<div class="container">

<!-- ê¸°ê°„ ê²€ìƒ‰ -->
<div class="range-box">
  <div class="range-row">
    <input type="date" id="range-start">
    <input type="date" id="range-end">
  </div>
  <div class="range-actions">
    <button id="btn-range">ê¸°ê°„ ì¡°íšŒ</button>
    <button id="btn-range-reset">ì´ˆê¸°í™”</button>
  </div>
</div>

<!-- ê²€ìƒ‰ -->
<div class="search-box">
  <input type="text" id="search" placeholder="ìƒí’ˆëª… ë˜ëŠ” ë°”ì½”ë“œ ê²€ìƒ‰">
</div>

<!-- ë§¤ì… / ë§¤ì¶œ ì„ íƒ -->

<!-- ì—‘ì…€ -->
<div class="excel-row">
  <!-- âœ… ì‘ì€ ì²´í¬ ë°•ìŠ¤ -->
  <div class="type-box">
    <label class="type-item">
      <input type="checkbox" id="chk-purchase" checked>
      <span>ë§¤ì…</span>
    </label>

    <label class="type-item">
      <input type="checkbox" id="chk-sale" checked>
      <span>ë‚©í’ˆ</span>
    </label>

    <label class="type-item">
      <input type="checkbox" id="chk-partner" checked>
      <span>ê±°ë˜ì²˜</span>
    </label>
  </div>

  <!-- ì—‘ì…€ ë²„íŠ¼ -->
  <button id="btn-excel" class="excel-btn">â¬‡ì—‘ì…€</button>
  <!-- <button class="text-btn" id="btn-stock">ì¬ê³  ê´€ë¦¬</button> -->
</div>

<div id="list"></div>
<div id="empty" class="empty" style="display:none;">ì €ì¥ëœ ê±°ë˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>

</div>


<script>
const listEl = document.getElementById("list");
const emptyEl = document.getElementById("empty");
const searchEl = document.getElementById("search");
const rangeStartEl = document.getElementById("range-start");
const rangeEndEl = document.getElementById("range-end");
// âœ… ë§¤ì…/ë§¤ì¶œ ì²´í¬ë°•ìŠ¤
const chkPurchase = document.getElementById("chk-purchase");
const chkSale = document.getElementById("chk-sale");
const chkPartner = document.getElementById("chk-partner");

function n(v){ return Number(v)||0; }
function fmt(v){ return (Number(v)||0).toLocaleString("ko-KR"); }

let purchases = JSON.parse(localStorage.getItem("purchase_list")||"[]")
  .map(i => ({
    _key:"purchase_list",
    _id:i.id,
    type:"purchase",
    date:i.purchaseDate,
    name:i.name,
    barcode:i.barcode,
    price:n(i.price),
    qty:n(i.qty),
    total:n(i.price)*n(i.qty),
    memo: i.memo || "",   // âœ… ì¶”ê°€
    createdAt: i.createdAt   // âœ… í•µì‹¬
  }));

let sales = JSON.parse(localStorage.getItem("sales_list")||"[]")
  .map(i => ({
    _key:"sales_list",
    _id:i.id,
    type:"sale",
    date:i.saleDate,
    partner: i.partner || "", 
    name:i.productName||i.name,
    barcode:i.barcode,
    price:n(i.price),
    qty:n(i.qty),
    total: n(i.price) * n(i.qty),   // âœ… ë‚©í’ˆ ì´ì•¡ ì¶”ê°€
    memo: i.memo || "",
    createdAt: i.createdAt
  }));

let originList = [...purchases, ...sales];
originList.sort((a, b) => {
  return new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime();
});
let viewList = [...originList];

function render(data){
  listEl.innerHTML="";
  if(!data.length){
    emptyEl.style.display="block";
    return;
  }
  emptyEl.style.display="none";

  data.forEach(it=>{
    const div = document.createElement("div");
    div.className = "card " + it.type;
    div.style.cursor = "pointer";
    div.onclick = (e) => {
      if (e.target.classList.contains("btn-del")) return;
      location.href = `deal_view.html?key=${it._key}&id=${it._id}`;
    };
    div.innerHTML = `
      <button class="btn-del">âœ•</button>
      <span class="badge ${it.type}">${it.type==="purchase" ? "ë§¤ì…" : "ë‚©í’ˆ"}</span>
      ${
        it.type === "sale" && it.partner
          ? `<div class="meta"><strong>ê±°ë˜ì²˜: ${it.partner}</strong></div>`
          : ""
      }
      <div class="title">${it.name}</div>
      <div class="barcode">ë°”ì½”ë“œ ${it.barcode}</div>
      <div class="meta">${it.date}</div>
      <div class="meta">ê°€ê²© ${fmt(it.price)} Â· ìˆ˜ëŸ‰ ${fmt(it.qty)}</div>

      <div class="amount">
        ${it.type === "purchase" ? "ë§¤ì… ì´ì•¡" : "ë‚©í’ˆ ì´ì•¡"} ${fmt(it.total)} ì›
      </div>

      ${it.memo ? `<div class="meta">ë©”ëª¨: ${it.memo}</div>` : ""}
    `;

    div.querySelector(".btn-del").onclick = ()=>{
      if(!confirm("ì´ ê±°ë˜ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;
      const raw = JSON.parse(localStorage.getItem(it._key)||"[]")
        .filter(x => x.id !== it._id);
      localStorage.setItem(it._key, JSON.stringify(raw));
      originList = originList.filter(x => x._id !== it._id);
      viewList = viewList.filter(x => x._id !== it._id);
      render(viewList);
    };

    listEl.appendChild(div);
  });
}

function applyFilters(){
  const q = searchEl.value.trim();
  const sVal = rangeStartEl.value;
  const eVal = rangeEndEl.value;

  // âœ… ë‚ ì§œ ë¹„êµëŠ” ë¬¸ìì—´ì´ ì•„ë‹ˆë¼ 'ë‚ ì§œê°’(íƒ€ì„ìŠ¤íƒ¬í”„)'ìœ¼ë¡œ ì²˜ë¦¬ (ë¸Œë¼ìš°ì €/í¬ë§· ì°¨ì´ ì•ˆì „)
  const sTs = sVal ? new Date(sVal + "T00:00:00").getTime() : null;
  const eTs = eVal ? new Date(eVal + "T23:59:59").getTime() : null;

  viewList = originList.filter(it=>{
    // 0) íƒ€ì… í•„í„° (ê±°ë˜ì²˜ ì²´í¬ ì‹œ ë‚©í’ˆì€ ê°•ì œ í—ˆìš©)
    if (it.type === "purchase") {
      if (!chkPurchase.checked) return false;
    }

    if (it.type === "sale") {
      if (!chkSale.checked && !chkPartner.checked) return false;
    }
    // 1) í‚¤ì›Œë“œ
    if (q) {
      let target = (it.name || "") + (it.barcode || "");

      // âœ… ê±°ë˜ì²˜ ì²´í¬ë˜ì–´ ìˆì„ ë•Œë§Œ í¬í•¨
      if (chkPartner.checked) {
        target += (it.partner || "");
      }

      if (!target.includes(q)) return false;
    }

    // 2) ë‚ ì§œ (purchaseDate/saleDateê°€ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ê°„ í•„í„°ì—ì„œ ì œì™¸)
    const dTs = it.date ? new Date(it.date + "T12:00:00").getTime() : null;
    if(sTs !== null && (dTs === null || dTs < sTs)) return false;
    if(eTs !== null && (dTs === null || dTs > eTs)) return false;

    return true;
  });

  render(viewList);
}

searchEl.addEventListener("input", applyFilters);
chkPurchase.addEventListener("change", applyFilters);
chkSale.addEventListener("change", applyFilters);
chkPartner.addEventListener("change", applyFilters);
document.getElementById("btn-range").onclick = applyFilters;
document.getElementById("btn-range-reset").onclick = ()=>{
  rangeStartEl.value="";
  rangeEndEl.value="";
  searchEl.value="";
  viewList=[...originList];
  render(viewList);
};

document.getElementById("btn-excel").onclick = ()=>{
  if(!viewList.length){ alert("ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

  let csv = "\uFEFFêµ¬ë¶„,ë‚ ì§œ,ìƒí’ˆëª…,ë°”ì½”ë“œ,ìˆ˜ëŸ‰,ê°€ê²©,ì´ì•¡,ë©”ëª¨\n";
  viewList.forEach(it=>{
    if(it.type==="purchase"){
      csv += `ë§¤ì…,${it.date},${it.name},${it.barcode},${it.qty},${it.price},${it.total},${it.memo || ""}\n`;
    }else{
      csv += `ë‚©í’ˆ,${it.date},${it.name},${it.barcode},${it.qty},${it.price},${it.total},${it.memo || ""}\n`;
    }
  });

  const blob = new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "transaction_list.csv";
  a.click();
  URL.revokeObjectURL(url);
};

render(viewList);

const btnStock = document.getElementById("btn-stock");

if (btnStock) {
  btnStock.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì°¨ë‹¨
    location.href = "stock_list.html";
  });
}
// ğŸ” ìƒë‹¨ ë„¤ë¹„ ì´ë™
document.querySelectorAll(".nav-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const link = btn.dataset.link;
    if (link) location.href = link;
  });
});
// â­ í˜„ì¬ í˜ì´ì§€ active ì²˜ë¦¬
  const path = location.pathname;

  document.querySelectorAll(".nav-btn").forEach(btn => {
    const link = btn.dataset.link;
    if (!link) return;

    if (path.includes(link)) {
      btn.classList.add("active");
    }
  });
</script>

</body>
</html>
