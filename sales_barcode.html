<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ë§¤ì¶œ ë°”ì½”ë“œ ë“±ë¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff0f0; /* ë‚©í’ˆ: ì—°í•œ ë¹¨ê°• */
      margin: 0;
      padding: 20px;
      text-align: center;
    }

    .page-container {
      max-width: 420px;
      margin: 0 auto;
      padding: 0 16px 24px;
      box-sizing: border-box;
      background: #fff0f0; /* ë‚©í’ˆ ë°•ìŠ¤ */
    }

    h1 {
      font-size: 20px;
      margin: 8px 0 16px;
      text-align: center;
    }

    .field {
      margin-bottom: 12px;
    }

    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 6px;
      color: #333;
      text-align: center;
    }

    .field input,
    .field textarea {
      width: 100%;
      padding: 10px;
      font-size: 15px;
      box-sizing: border-box;
      text-align: center;
    }

    .field input[readonly] {
      background: #f5f5f5;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    /* ===== ë§¤ì…ê³¼ ë™ì¼í•œ ìŠ¤ìº” ë²„íŠ¼ ìŠ¤íƒ€ì¼ ===== */
    .btn-wrap {
      display: flex;
      justify-content: center;
      margin-top: 12px;
    }

    .ios-pill-btn {
      appearance: none;
      -webkit-appearance: none;
      background-color: #007aff;
      color: #000;
      border: none;
      border-radius: 999px;
      width: 100%;
      padding: 12px 0;
      padding: 10px 22px;
      font-size: 17px;
      font-weight: 500;
      cursor: pointer;
    }

    .ios-pill-btn:active { background-color: #005ecb; }

    .btn {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 10px;
    }

    .btn-gray {
      background: #f3f3f3;
      border: 1px solid #ccc;
    }

    .btn-blue {
      background: #007aff;
      color: #fff;
    }

    /* ğŸ”’ ìŠ¤ìº” ì „ì—ëŠ” ìƒí’ˆ ì…ë ¥ í¼ ìˆ¨ê¹€ */
    /* #product-form {
      display: none;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    } */
    
    /* ğŸ“¦ ìƒí’ˆ ì…ë ¥ í¼ (í•­ìƒ í‘œì‹œ) */
    #product-form {
      display: block;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    }

    

    /* ğŸ“¦ ì¹´íŠ¸ í‘œì‹œ ì˜ì—­ (ë§¤ì…ê³¼ ìœ ì‚¬) */
    #cart-list {
      margin: 12px 0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      text-align: left;
      background: #fff;
    }
    #cart-list .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 4px;
      padding: 10px 0;
      border-bottom: 1px dashed #eee;
    }
    #cart-list .row:last-child { border-bottom: none; }
    #cart-list .meta { color:#666; font-size: 12px; }
    #cart-list .title { font-weight: 700; }

    #save-count {
      margin-top: 12px;
      font-size: 14px;
      color: #333;
      display: none;
    }
    /* =========================
      ì…ë ¥ í•„ë“œ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ë‚©í’ˆ)
      ========================= */
    .field input,
    .field textarea {
      background: #ffffff;          /* í° ì¹´ë“œ */
      border: 1px solid #e2e2e2;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    /* ì½ê¸° ì „ìš© í•„ë“œëŠ” ì‚´ì§ í†¤ ë‹¤ìš´ */
    .field input[readonly] {
      background: #f7f7f7;
      box-shadow: none;
    }

    #cart-list .row {
      position: relative;
      cursor: pointer;
    }

    #cart-list .row:hover {
      background: #fff5f5;
    }

    .del-x {
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 18px;
      color: #999;
      cursor: pointer;
    }

    .del-x:hover {
      color: #ff3b30;
    }
    
  </style>
</head>

<body>
  <div class="page-container">
    <h1>ë‚©í’ˆ ë°”ì½”ë“œ ë“±ë¡</h1>

    <!-- 1) ë‚©í’ˆì¼ì -->
    <div class="field">
      <label>ë‚©í’ˆì¼ì</label>
      <input type="date" id="saleDate">
    </div>

    <!-- 2) ê±°ë˜ì²˜ -->
    <div class="field">
      <label>ê±°ë˜ì²˜</label>
      <input type="text" id="partner" placeholder="ê±°ë˜ì²˜ëª…">
    </div>

    <!-- 3) ë°”ì½”ë“œ ìŠ¤ìº” ë²„íŠ¼ -->
    <div class="btn-wrap">
      <button id="btnStart" class="ios-pill-btn">ìŠ¤ìº” ì‹œì‘</button>
    </div>

    <!-- 4) ìŠ¤ìº” ì˜ì—­ -->
    <div id="scan-wrapper" style="display:none; margin-top:12px; position:relative;">
      <div
        id="reader"
        style="
          width:100%;
          max-width:420px;
          height:320px;
          background:#000;
          border-radius:12px;
          overflow:hidden;
          margin:0 auto;
        "
      ></div>

      <div
        id="scan-sector"
        style="
          position:absolute;
          top:55%;
          left:50%;
          width:240px;
          height:120px;
          transform:translate(-50%, -50%);
          border:2px solid #00ff88;
          pointer-events:none;
        "
      ></div>
    </div>
    
    <!-- 5) ì¸ì‹ ê²°ê³¼ -->
    <div id="result-box" style="margin-top:12px; font-size:14px; text-align:center; color:#666;">
      ë°”ì½”ë“œ ìŠ¤ìº” ë˜ëŠ” ìƒí’ˆëª… / ë°”ì½”ë“œë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”<br>
      <span id="barcode-value" style="display:none;">ì—†ìŒ</span>
    </div>

    <!-- 6) ìŠ¤ìº” í›„ ì—´ë¦¬ëŠ” ì…ë ¥ ì˜ì—­ -->
    <div id="product-form">

      <!-- ì €ì¥ëœ ë§¤ì¶œ ê°œìˆ˜ í‘œì‹œ (ì „ì²´ ë“±ë¡ í›„ ì—…ë°ì´íŠ¸) -->
      <div id="save-count">
        <b>ì €ì¥ëœ ë§¤ì¶œ:</b> <b id="save-count-num">0</b>ê±´
      </div>

      <div class="field">
        <label>ë°”ì½”ë“œ</label>
        <input
          id="input-barcode"
          placeholder="ë°”ì½”ë“œ ì§ì ‘ ì…ë ¥ ê°€ëŠ¥"
          inputmode="numeric"
        >
      </div>

      <div class="field" id="purchase-image-box" style="display:none;">
        <label>ìƒí’ˆ ì´ë¯¸ì§€ (ìµœê·¼ ë§¤ì…)</label>
        <img
          id="purchase-image"
          style="max-width:100%; border-radius:10px;"
        >
      </div>

      <div class="field">
        <label>ìƒí’ˆëª…</label>
        <input type="text" id="input-name" placeholder="">
      </div>
      <div id="name-suggest"
          style="
            display:none;
            background:#fff;
            border:1px solid #ddd;
            border-radius:8px;
            margin-top:4px;
            max-height:160px;
            overflow-y:auto;
            text-align:left;
            font-size:14px;
          ">
      </div>

      <div class="field">
        <label>ê°€ê²©</label>
        <input type="text" id="price" inputmode="numeric" placeholder="">
      </div>

      <div class="field">
        <label>ìˆ˜ëŸ‰</label>
        <input type="text" id="qty" inputmode="numeric" placeholder="">
      </div>     

      <div class="field">
        <label>ë©”ëª¨</label>
        <textarea id="memo" placeholder=""></textarea>
      </div>

      <button id="btnAddToCart" class="btn btn-gray">ì¶”ê°€</button>

      <!-- âœ… ëˆ„ì  í‘œì‹œ ì˜ì—­ -->
      <div id="cart-list"></div>

      <!-- ğŸ” ë°˜í’ˆ (ê±°ë˜ì²˜ ê¸°ì¤€) -->
      <div class="field">
        <label>ë°˜í’ˆ</label>
        <input
          type="text"
          id="returnNote"
          placeholder="ë°˜í’ˆ ë‚´ìš© ë˜ëŠ” ìˆ˜ëŸ‰"
        >
      </div>

      <!-- ğŸ“ ì•½êµ­ ì´ìŠˆ ë©”ëª¨ (ê±°ë˜ì²˜ ê¸°ì¤€) -->
      <div class="field">
        <label>ì•½êµ­ ë©”ëª¨</label>
        <textarea
          id="storeMemo"
          placeholder="ì•½êµ­ ê´€ë ¨ ì´ìŠˆ, ìš”ì²­ì‚¬í•­ ë“±"
        ></textarea>
      </div>
      <div class="field">
        <label>ìˆ˜ê¸ˆì•¡</label>
        <input type="text" id="paid" inputmode="numeric" placeholder="">
      </div>

      <div class="field">
        <label>ë‚©í’ˆê¸ˆì•¡</label>
        <input type="text" id="stockAmount" inputmode="numeric" placeholder="" readonly>
      </div>
      
      <!-- âœ… ëˆ„ì  ì¶”ê°€/ì €ì¥ ë²„íŠ¼ -->
      <button id="btnSaveAll" class="btn btn-blue">ì „ì²´ ë“±ë¡</button>
    </div>
  </div>

  <!-- âœ… ìƒí’ˆëª…/ê°€ê²© ê¸°ì–µ(ë§¤ì…ê³¼ ë‹¤ë¥´ê²Œ í™œìš©) -->
  <script src="static/js/sales_price_master.js"></script>

  <script>
    // =========================
    // 0) ìœ í‹¸
    // =========================
    function parseNumber(val) {
      return Number(String(val ?? "").replace(/,/g, "")) || 0;
    }
    function formatNumber(num) {
      return (Number(num) || 0).toLocaleString("ko-KR");
    }
    function rand6() {
      return Math.random().toString(36).slice(2, 8);
    }

    // =========================
    // ğŸ–¼ï¸ ìµœê·¼ ë§¤ì… ì´ë¯¸ì§€ ì°¾ê¸°
    // =========================
    function findLatestPurchaseImage(barcode) {
      if (!barcode) return null;

      const list = JSON.parse(localStorage.getItem("purchase_list") || "[]");

      // ìµœì‹  ë§¤ì…ë¶€í„° ì—­ìˆœ ê²€ìƒ‰
      for (let i = list.length - 1; i >= 0; i--) {
        const it = list[i];
        if (it.barcode === barcode && it.image) {
          return it.image;
        }
      }
      return null;
    }

    

    // =========================
    // ğŸ“š ëª¨ë“  ìƒí’ˆëª… + ë°”ì½”ë“œ ìˆ˜ì§‘
    // =========================
    function getAllProducts() {
      const map = new Map();

      // 1ï¸âƒ£ ìƒí’ˆ ë§ˆìŠ¤í„°
      if (window.ProductMaster?.getAll) {
        const all = ProductMaster.getAll();
        for (const bc in all) {
          if (all[bc]?.name) {
            map.set(all[bc].name, bc);
          }
        }
      }

      // 2ï¸âƒ£ ê¸°ì¡´ ë§¤ì…
      const purchases = JSON.parse(localStorage.getItem("purchase_list") || "[]");
      purchases.forEach(p => {
        const name = p.name || p.productName;
        if (name && p.barcode) {
          map.set(name, p.barcode);
        }
      });

      // 3ï¸âƒ£ ê¸°ì¡´ ë‚©í’ˆ
      const sales = JSON.parse(localStorage.getItem("sales_list") || "[]");
      sales.forEach(s => {
        if (s.productName && s.barcode) {
          map.set(s.productName, s.barcode);
        }
      });

      return Array.from(map.entries()); // [ [name, barcode], ... ]
    }

    // =========================
    // ğŸ” ìƒí’ˆëª…ìœ¼ë¡œ ë°”ì½”ë“œ ì°¾ê¸° (ë‚©í’ˆìš©)
    // =========================
    function findBarcodeByName(productName) {
      if (!productName) return "";

      const name = productName.trim();

      // 1ï¸âƒ£ ìƒí’ˆ ë§ˆìŠ¤í„°
      if (window.ProductMaster) {
        const all = ProductMaster.getAll?.() || {};
        for (const bc in all) {
          if ((all[bc].name || "") === name) {
            return bc;
          }
        }
      }

      // 2ï¸âƒ£ ê¸°ì¡´ ë§¤ì… ë°ì´í„°
      const purchases = JSON.parse(localStorage.getItem("purchase_list") || "[]");
      const p = purchases.find(x => (x.name || x.productName) === name);
      if (p) return p.barcode || "";

      // 3ï¸âƒ£ ê¸°ì¡´ ë‚©í’ˆ ë°ì´í„°
      const sales = JSON.parse(localStorage.getItem("sales_list") || "[]");
      const s = sales.find(x => x.productName === name);
      if (s) return s.barcode || "";

      return "";
    }
    // =========================
    // ğŸ“¦ ë°”ì½”ë“œ ê¸°ì¤€ ìë™ ì±„ìš°ê¸° (ê³µí†µ)
    // =========================
    function autoFillByBarcode({
      barcode,
      partner = "",
      nameEl,
      priceEl
    }) {
      if (!barcode) return;

      // 1ï¸âƒ£ ìƒí’ˆ ë§ˆìŠ¤í„°
      if (window.ProductMaster) {
        const m = ProductMaster.get(barcode);
        if (m && !nameEl.value) {
          nameEl.value = m.name || "";
        }
      }

      // 2ï¸âƒ£ ê±°ë˜ì²˜ ê¸°ì¤€ ë‚©í’ˆ ê°€ê²© (ë‚©í’ˆ í™”ë©´)
      if (partner && window.SalesPriceMaster && priceEl) {
        const p = SalesPriceMaster.get(partner, barcode);
        if (p && !priceEl.value) {
          priceEl.value = formatNumber(p);
        }
      }

      // 3ï¸âƒ£ ê¸°ì¡´ ë§¤ì… / ë‚©í’ˆ ë°ì´í„°ì—ì„œ ìƒí’ˆëª… ë³´ì™„
      const purchases = JSON.parse(localStorage.getItem("purchase_list") || "[]");
      const sales     = JSON.parse(localStorage.getItem("sales_list") || "[]");

      const found =
        purchases.find(p => p.barcode === barcode) ||
        sales.find(s => s.barcode === barcode);

      if (found && !nameEl.value) {
        nameEl.value = found.productName || found.name || "";
      }
    }

    // =========================
    // 1) DOM
    // =========================
    const saleDateEl = document.getElementById("saleDate");
    const partnerEl  = document.getElementById("partner");

    const barcodeSpan = document.getElementById("barcode-value");
    const formEl      = document.getElementById("product-form");

    const barcodeEl = document.getElementById("input-barcode");
    const purchaseImageBox = document.getElementById("purchase-image-box");
    const purchaseImageEl  = document.getElementById("purchase-image");
    const nameEl    = document.getElementById("input-name");
    const suggestBox = document.getElementById("name-suggest");

    nameEl.addEventListener("input", () => {
      const keyword = nameEl.value.trim();
      if (keyword.length < 2) {
        suggestBox.style.display = "none";
        return;
      }

      const list = getAllProducts();
      const matches = list.filter(([name]) =>
        name.includes(keyword)
      );

      if (!matches.length) {
        suggestBox.style.display = "none";
        return;
      }

      suggestBox.innerHTML = matches.map(([name, bc]) => `
        <div
          style="padding:8px 10px; cursor:pointer;"
          data-barcode="${bc}"
          data-name="${name}"
        >
          ${name}
        </div>
      `).join("");

      suggestBox.style.display = "block";
    });
    const priceEl   = document.getElementById("price");
    // =========================
    // âœï¸ ìƒí’ˆëª… ì…ë ¥ â†’ ë°”ì½”ë“œ ìë™ ì±„ìš°ê¸°
    // =========================
    nameEl.addEventListener("input", () => {
      const name = nameEl.value.trim();
      if (!name) return;

      // ì´ë¯¸ ë°”ì½”ë“œê°€ ìˆìœ¼ë©´ ë®ì–´ì“°ì§€ ì•ŠìŒ
      if (barcodeEl.value) return;

      const foundBarcode = findBarcodeByName(name);
      if (!foundBarcode) return;

      barcodeEl.value = foundBarcode;

      // ë°”ì½”ë“œê°€ ì±„ì›Œì¡Œìœ¼ë‹ˆ ê¸°ì¡´ ë°”ì½”ë“œ ê¸°ì¤€ ìë™ ì±„ìš°ê¸° ë¡œì§ ì‹¤í–‰
      autoFillByBarcode({
        barcode: foundBarcode,
        partner: partnerEl.value.trim(),
        nameEl,
        priceEl
      });
    });
    // =========================
    // âœï¸ ë°”ì½”ë“œ ì§ì ‘ ì…ë ¥ ì‹œ ìë™ ì±„ìš°ê¸°
    // =========================
    barcodeEl.addEventListener("input", () => {
      const code = barcodeEl.value.trim();
      if (!code) return;

      autoFillByBarcode({
        barcode: code,
        partner: typeof partnerEl !== "undefined" ? partnerEl.value.trim() : "",
        nameEl,
        priceEl
      });

      const img = findLatestPurchaseImage(code);
      if (img) {
        purchaseImageEl.src = img;
        purchaseImageBox.style.display = "block";
      } else {
        purchaseImageBox.style.display = "none";
      }  
    });
    const qtyEl     = document.getElementById("qty");
    const paidEl    = document.getElementById("paid");
    const stockEl   = document.getElementById("stockAmount");
    const memoEl    = document.getElementById("memo");
    
    const returnEl   = document.getElementById("returnNote");
    const storeMemoEl = document.getElementById("storeMemo");
    const cartBox   = document.getElementById("cart-list");
    const btnAdd    = document.getElementById("btnAddToCart");
    const btnSaveAll= document.getElementById("btnSaveAll");

    // =========================
    // 2) ê¸°ë³¸ê°’: ì˜¤ëŠ˜ ë‚ ì§œ
    // =========================
    (function setToday(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      saleDateEl.value = `${yyyy}-${mm}-${dd}`;
    })();

    // =========================
    // 3) ìˆ«ì í¬ë§· (blurì—ì„œë§Œ ì½¤ë§ˆ)
    // =========================
    [priceEl, qtyEl, paidEl, stockEl].forEach(el => {
      el.addEventListener("blur", () => {
        const v = parseNumber(el.value);
        el.value = v ? formatNumber(v) : "";
      });
    });
    // =========================
    // âœ… 3-1) ì¬ê³ ê¸ˆì•¡ ìë™ ê³„ì‚°: ê°€ê²© x ìˆ˜ëŸ‰
    // =========================
    function updateStockAmountAuto() {
      const price = parseNumber(priceEl.value);
      const qty   = parseNumber(qtyEl.value);

      const stockAmount = price * qty;

      // ê²°ê³¼ í‘œì‹œ(ì½¤ë§ˆ)
      stockEl.value = stockAmount > 0 ? formatNumber(stockAmount) : "";
    }

    // =========================
    // âœ… 3-2) ì¹´íŠ¸ ê¸°ì¤€ ì¬ê³ ê¸ˆì•¡ ëˆ„ì  ê³„ì‚°
    // =========================
    function updateStockAmountFromCart() {
      const total = saleCart.items.reduce(
        (sum, it) => sum + Number(it.stockAmount || 0),
        0
      );

      stockEl.value = total > 0 ? formatNumber(total) : "";
    }

    // ê°€ê²©/ìˆ˜ëŸ‰ ì…ë ¥ ì¤‘ì—ë„ ì‹¤ì‹œê°„ ë°˜ì˜
    priceEl.addEventListener("input", updateStockAmountAuto);
    qtyEl.addEventListener("input", updateStockAmountAuto);

    // blurë¡œ ì½¤ë§ˆ ì°íŒ í›„ì—ë„ í•œë²ˆ ë” ë§ì¶¤
    priceEl.addEventListener("blur", updateStockAmountAuto);
    qtyEl.addEventListener("blur", updateStockAmountAuto);
    // =========================
    // 4) ë§¤ì¶œ ì¹´íŠ¸(ëˆ„ì ) - localStorageì— ì €ì¥í•´ì„œ ìƒˆë¡œê³ ì¹¨í•´ë„ ìœ ì§€
    // =========================
    const CART_KEY = "sales_cart_tmp";

    const saleCart = {
      items: [],
      load() {
        try {
          this.items = JSON.parse(localStorage.getItem(CART_KEY) || "[]");
        } catch(e) {
          this.items = [];
        }
      },
      save() {
        localStorage.setItem(CART_KEY, JSON.stringify(this.items));
      },
      add(item) {
        this.items.push(item);
        this.save();
        this.render();
      },
      clear() {
        this.items = [];
        this.save();
        this.render();
        stockEl.value = "";
      },
      render() {
  if (!this.items.length) {
    cartBox.innerHTML = "<div class='meta'>ì•„ì§ ì¶”ê°€ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. (ìŠ¤ìº” â†’ ê°’ í™•ì¸ â†’ ì¶”ê°€)</div>";
    return;
  }

  let html = "";

  this.items.forEach((it, idx) => {
    if(!it.tempId) it.tempId = "s_tmp_" + Date.now() + "_" + rand6();

    const memoSafe = String(it.memo||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;")
      .replaceAll("\n","<br>");

    html += `
      <div class="row" data-tempid="${it.tempId}">
        <span class="del-x">Ã—</span>

        <div class="title">${idx+1}. ${it.productName} (${it.barcode})</div>
        <div class="meta">ê°€ê²© ${formatNumber(it.price)} | ìˆ˜ëŸ‰ ${formatNumber(it.qty)}</div>
        ${it.memo ? `<div class="meta">ë©”ëª¨: ${memoSafe}</div>` : ""}
      </div>
    `;
  });

  cartBox.innerHTML = html;
}
    };

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    saleCart.load();
    saleCart.render();

    cartBox.addEventListener("click", (e) => {

      // âŒ X í´ë¦­ â†’ ì‚­ì œ
      const delBtn = e.target.closest(".del-x");
      if (delBtn) {
        e.stopPropagation();

        const row = delBtn.closest(".row");
        const tempId = row.getAttribute("data-tempid");

        if (!confirm("ì´ í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?")) return;

        saleCart.items = saleCart.items.filter(x => x.tempId !== tempId);
        saleCart.save();
        saleCart.render();
        updateStockAmountFromCart();

        if (editingTempId === tempId) editingTempId = null;
        return;
      }

      // âœï¸ row í´ë¦­ â†’ ìˆ˜ì •
      const row = e.target.closest(".row");
      if (!row) return;

      const tempId = row.getAttribute("data-tempid");
      const it = saleCart.items.find(x => x.tempId === tempId);
      if (!it) return;

      editingTempId = tempId;

      barcodeEl.value = it.barcode || "";
      nameEl.value = it.productName || "";
      priceEl.value = it.price ? formatNumber(it.price) : "";
      qtyEl.value = it.qty ? formatNumber(it.qty) : "";
      paidEl.value = it.paid ? formatNumber(it.paid) : "";
      stockEl.value = it.stockAmount ? formatNumber(it.stockAmount) : "";
      memoEl.value = it.memo || "";

      formEl.style.display = "block";
    });


    // =========================
    // 5) ë°”ì½”ë“œ ì¸ì‹ ì‹œ í¼ ì—´ê¸° + ë°”ì½”ë“œ/ìƒí’ˆë§ˆìŠ¤í„° ìë™ ì±„ìš°ê¸°
    // =========================
    const observer = new MutationObserver(() => {
      const code = barcodeSpan.textContent.trim();
      if (!code || code === "ì—†ìŒ") return;

      barcodeEl.value = code;
      // formEl.style.display = "block";

      autoFillByBarcode({
        barcode: code,
        partner: typeof partnerEl !== "undefined" ? partnerEl.value.trim() : "",
        nameEl,
        priceEl
      });
      const img = findLatestPurchaseImage(code);
      if (img) {
        purchaseImageEl.src = img;
        purchaseImageBox.style.display = "block";
      } else {
        purchaseImageBox.style.display = "none";
      }
    });
    observer.observe(barcodeSpan, { childList: true });

    // =========================
    // 6) [ì¶”ê°€] ë²„íŠ¼: í˜„ì¬ ì…ë ¥ê°’ì„ ì¹´íŠ¸ë¡œ ëˆ„ì 
    // =========================
    // âœ… ìˆ˜ì •ëª¨ë“œ ìƒíƒœ
let editingTempId = null;

btnAdd.addEventListener("click", () => {
  const item = {
    tempId: editingTempId || ("s_tmp_" + Date.now() + "_" + rand6()),
    barcode: barcodeEl.value.trim(),
    productName: nameEl.value.trim(),
    price: parseNumber(priceEl.value),
    qty: parseNumber(qtyEl.value),
    stockAmount: parseNumber(priceEl.value) * parseNumber(qtyEl.value),
    memo: memoEl.value.trim()
  };

  if (!item.barcode || !item.productName) {
    alert("ë°”ì½”ë“œì™€ ìƒí’ˆëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");
    return;
  }
  if (item.qty <= 0) {
    alert("ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
    return;
  }

  if (editingTempId) {
    const idx = saleCart.items.findIndex(x => x.tempId === editingTempId);
    if (idx >= 0) {
      saleCart.items[idx] = item;
      saleCart.save();
      saleCart.render();
      updateStockAmountFromCart();
    } else {
      saleCart.add(item);
      updateStockAmountFromCart(); // âœ… ëˆ„ì  ì¬ê³ ê¸ˆì•¡ ê³„ì‚°
    }
  } else {
    saleCart.add(item);
    updateStockAmountFromCart(); // âœ… ëˆ„ì  ì¬ê³ ê¸ˆì•¡ ê³„ì‚°
  }

  if (window.ProductMaster) {
    ProductMaster.set(item.barcode, { name: item.productName, price: item.price });
  }

  editingTempId = null;

  barcodeEl.value = "";
  nameEl.value = "";
  priceEl.value = "";
  qtyEl.value = "";
  paidEl.value = "";
  // stockEl.value = "";
  memoEl.value = "";
  barcodeSpan.textContent = "ì—†ìŒ";
});

    // =========================
    // 7) [ì „ì²´ ë“±ë¡] ë²„íŠ¼: sales_listì— ì €ì¥
    // =========================
    btnSaveAll.addEventListener("click", () => {
      const saleDate = saleDateEl.value;
      const partner  = partnerEl.value.trim();

      if (!saleDate) {
        alert("ë‚©í’ˆì¼ìë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
      }
      if (!partner) {
        alert("ê±°ë˜ì²˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }

      const items = saleCart.items;
      if (!items.length) {
        alert("ë“±ë¡í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € [ì¶”ê°€]ë¡œ ëˆ„ì í•´ ì£¼ì„¸ìš”.");
        return;
      }

      const key = "sales_list";
      const list = JSON.parse(localStorage.getItem(key) || "[]");

      const paidTotal = parseNumber(paidEl.value);
      const stockTotal = items.reduce(
        (sum, it) => sum + (it.price * it.qty), 0
      );

      const returnNote = returnEl.value.trim();
      const storeMemo  = storeMemoEl.value.trim();

      items.forEach(it => {
        list.push({
          id: "s_" + Date.now() + "_" + rand6(),
          saleDate,
          partner,
          barcode: it.barcode,
          productName: it.productName,
          price: it.price,
          qty: it.qty,
          memo: it.memo,

          // âœ… ê±°ë˜ì²˜ ê¸°ì¤€ ì •ë³´ (ëª¨ë“  ìƒí’ˆ ë™ì¼)
          paid: paidTotal,
          stockAmount: stockTotal,

          returnNote,
          storeMemo,          

          createdAt: new Date().toISOString()
        });
        // âœ… ë‚©í’ˆ ê°€ê²© ê¸°ì–µ (ê±°ë˜ì²˜ + ë°”ì½”ë“œ ê¸°ì¤€)
        if (window.SalesPriceMaster && it.price > 0) {
          SalesPriceMaster.set(partner, it.barcode, it.price);
        }
      });
      localStorage.setItem(key, JSON.stringify(list));
      saleCart.clear();
      localStorage.removeItem("sales_cart_tmp"); // âœ… ì„ì‹œ ì¹´íŠ¸ ì™„ì „ ì´ˆê¸°í™”

      returnEl.value = "";
      storeMemoEl.value = "";

      // ì €ì¥ ê°œìˆ˜ í‘œì‹œ
      document.getElementById("save-count").style.display = "block";
      document.getElementById("save-count-num").textContent = list.length;

      alert("ë‚©í’ˆ ìƒí’ˆì´ ëª¨ë‘ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
      location.href = "purchase_list.html";

      // âœ… ë¦¬ìŠ¤íŠ¸ í™”ë©´ì´ ìˆë‹¤ë©´ ì•„ë˜ ê²½ë¡œë¡œ ì´ë™ (í•„ìš” ì‹œ ê²½ë¡œë§Œ ë°”ê¿”ì„œ ì“°ì„¸ìš”)
      // location.href = "/app/view/barcode/sales_list.html";
    });
  </script>

  <!-- âœ… ë°”ì½”ë“œ ìŠ¤ìº” ë¡œë”: iOSì™€ Android ëª¨ë‘ ì§€ì› -->
  <script>
    const ua = navigator.userAgent;
    const isIOS =
      /iPhone|iPad|iPod/i.test(ua) ||
      (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

    if (isIOS) {
      // Load html5-qrcode library and iOS-specific scanner.
      const lib = document.createElement("script");
      lib.src = "https://unpkg.com/html5-qrcode@2.4.0/html5-qrcode.min.js";
      lib.onload = () => {
        const iosScript = document.createElement("script");
        iosScript.src = "static/js/barcode_ios.js?v=" + Date.now();
        iosScript.onload = () => {
          if (window.initBarcodeIOS) {
            window.initBarcodeIOS();
          } else {
            console.error("initBarcodeIOS function is not defined in barcode_ios.js");
          }
        };
        document.body.appendChild(iosScript);
      };
      document.body.appendChild(lib);
    } else {
      // Fallback to Android scanner.
      const script = document.createElement("script");
      script.src = "static/js/barcode_android.js?v=" + Date.now();
      script.onload = () => {
        if (window.initBarcodeAndroid) {
          window.initBarcodeAndroid();
        } else {
          console.error("barcode_android ì´ˆê¸°í™” í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤");
        }
      };
      document.body.appendChild(script);
    }
    suggestBox.addEventListener("click", (e) => {
      const item = e.target.closest("[data-barcode]");
      if (!item) return;

      const name = item.dataset.name;
      const barcode = item.dataset.barcode;

      nameEl.value = name;
      barcodeEl.value = barcode;

      suggestBox.style.display = "none";

      // ê¸°ì¡´ ìë™ ì±„ìš°ê¸° ë¡œì§ ì¬ì‚¬ìš©
      autoFillByBarcode({
        barcode,
        partner: partnerEl.value.trim(),
        nameEl,
        priceEl
      });
    });
  </script>
</body>
</html>
