<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ë‚©í’ˆ ë“±ë¡</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;padding:20px;background:#fff0f0;font-family:Arial}
.box{max-width:420px;margin:0 auto;background:#fff0f0;border-radius:16px;padding:16px;box-shadow:0 4px 10px rgba(0,0,0,.06)}
h3{text-align:center;margin-bottom:14px}
.field{margin-bottom:12px}
label{font-size:13px;color:#555}
input,textarea,button{width:100%;padding:10px;font-size:15px;box-sizing:border-box}
textarea{min-height:60px}
button{border:none;border-radius:999px;margin-top:10px}
.btn-scan{background:#007aff;color:#fff}
.btn-add{background:#eee}
.btn-save{background:#007aff;color:#fff}
.cart{margin-top:12px;font-size:14px}
.cart-row{padding:8px 0;border-bottom:1px dashed #ddd}
/* =========================
   ì…ë ¥ í•„ë“œ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ë‚©í’ˆ)
   ========================= */
.field input,
.field textarea {
  background: #ffffff;          /* í° ì¹´ë“œ */
  border: 1px solid #e2e2e2;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}

/* ì½ê¸° ì „ìš© í•„ë“œëŠ” ì‚´ì§ í†¤ ë‹¤ìš´ */
.field input[readonly] {
  background: #f7f7f7;
  box-shadow: none;
}
/* ===============================
   ğŸ“ ê³µí†µ ê°„ê²© Â· ì •ë ¬ ê¸°ì¤€
   =============================== */

/* ëª¨ë“  ë©”ë‰´(ë¼ë²¨) ê°€ìš´ë° ì •ë ¬ */
.field label {
  text-align: center;
  margin-bottom: 6px;
}

/* ëª¨ë“  í•„ë“œ ê°„ê²© í†µì¼ */
.field {
  margin-bottom: 16px;
}

/* ì…ë ¥ê°’ ì¤„ ë¦¬ë“¬ ê³ ì • */
.field input,
.field textarea {
  line-height: 1.4;
  text-align: center;
}
/* ìŠ¤ìº” ë²„íŠ¼ ìœ„ì•„ë˜ ì—¬ë°± */
.btn-scan {
  margin: 16px 0;
}

/* ìŠ¤ìº” ë²„íŠ¼ ë‹¤ìŒì— ì˜¤ëŠ” ë°”ì½”ë“œ ì…ë ¥ ë°•ìŠ¤ */
.btn-scan + .field {
  margin-top: 12px;
}
/* ê°€ê²©Â·ìˆ˜ëŸ‰Â·ì´ì•¡ ì¤„ ë¦¬ë“¬ */
.cart-row {
  padding: 10px 0;
  line-height: 1.45;
}

/* ì´ì•¡ í•„ë“œ ìœ„ ì—¬ë°± í†µì¼ */
.field input[readonly],
.field input:disabled {
  margin-top: 4px;
}
/* í•˜ë‹¨ ë²„íŠ¼ ê°„ê²© í†µì¼ */
.btn-add,
.btn-save {
  margin-top: 14px;
}

h3 {
  text-align: center;
  margin-bottom: 14px;
}

.field label {
  display: block;        /* ğŸ”¥ í•µì‹¬ 1 */
  width: 100%;           /* ğŸ”¥ í•µì‹¬ 2 */
  text-align: center;    /* ê¸€ì ì¤‘ì•™ */
  margin-bottom: 6px;
}
</style>
</head>

<body>
<div class="box">
<h3 id="title">ë‚©í’ˆ ë“±ë¡</h3>

<div class="field">
<label>ë‚©í’ˆì¼ì</label>
<input type="date" id="date">
</div>

<div class="field">
<label>ê±°ë˜ì²˜</label>
<input id="partner">
</div>

<button class="btn-scan" id="btnScan">ë°”ì½”ë“œ ìŠ¤ìº”</button>

<div class="field">
<label>ë°”ì½”ë“œ</label>
<input id="barcode">
</div>

<!-- âœ… ìƒí’ˆ ì´ë¯¸ì§€ í‘œì‹œ ì˜ì—­ (ë‚©í’ˆìš©) -->
<div class="field" id="image-box" style="display:none;">
  <label>ìƒí’ˆ ì´ë¯¸ì§€</label>
  <img
    id="image-preview"
    style="
      width:100%;
      height:260px;
      object-fit:cover;
      border-radius:14px;
      box-shadow:0 4px 12px rgba(0,0,0,.08);
    "
  >
</div>

<div class="field">
<label>ìƒí’ˆëª…</label>
<input id="name">
</div>

<div class="field">
<label>ê°€ê²©</label>
<input id="price">
</div>

<div class="field">
<label>ìˆ˜ëŸ‰</label>
<input id="qty">
</div>

<div class="field">
  <label>ë‚©í’ˆ ì´ì•¡</label>
  <input id="stockAmount" disabled>
</div>

<div class="field">
<label>ë©”ëª¨</label>
<textarea id="memo"></textarea>
</div>

<div class="cart" id="cart"></div>

<button class="btn-add" id="btnAdd">ì¶”ê°€</button>
<button class="btn-save" id="btnSave">ì €ì¥</button>
</div>

<script>
// âœ… ìˆ«ì ì½¤ë§ˆ í‘œì‹œìš© (í™”ë©´ ì¶œë ¥ ì „ìš©)
function fmt(v) {
  return (Number(v) || 0).toLocaleString("ko-KR");
} 
// âœ… ì½¤ë§ˆ ì œê±° (ì €ì¥ìš©)
function uncomma(v){
  return String(v || "").replace(/,/g, "");
} 
function commaInput(el){
  el.addEventListener("input", () => {
    const raw = uncomma(el.value);
    if (raw === "") {
      el.value = "";
      return;
    }
    el.value = fmt(raw);
  });
}
const params = new URLSearchParams(location.search);
const editMode = params.get("mode")==="edit";
const editId = params.get("id");
// âœ… ìˆ˜ì • ëª¨ë“œì—ì„œëŠ” [ì¶”ê°€] ë²„íŠ¼ ìˆ¨ê¹€
if (editMode) {
  document.getElementById("btnAdd").style.display = "none";
}

const dateEl=document.getElementById("date");
const partnerEl=document.getElementById("partner");
const barcodeEl=document.getElementById("barcode");
const nameEl=document.getElementById("name");
const priceEl=document.getElementById("price");
const qtyEl=document.getElementById("qty");
const memoEl=document.getElementById("memo");
const stockAmountEl = document.getElementById("stockAmount");
const cartEl=document.getElementById("cart");
const titleEl=document.getElementById("title");

// ê³„ì‚° í•¨ìˆ˜
function updateStockAmount(){
  const price = Number(uncomma(priceEl.value));
  const qty   = Number(uncomma(qtyEl.value));
  stockAmountEl.value = fmt(price * qty);
}

// âœ… ì—¬ê¸°!
priceEl.addEventListener("input", updateStockAmount);
qtyEl.addEventListener("input", updateStockAmount);
commaInput(priceEl);
commaInput(qtyEl);

// âœ… [ìŠ¤ìº”] ë²„íŠ¼ í´ë¦­ ì—°ê²° (ì§€ê¸ˆì€ í•¨ìˆ˜ê°€ ì—†ì–´ì„œ alertë§Œ ëœ¸)
// barcode_android.js ì—°ë™ì„ ë¶™ì´ë©´ ì—¬ê¸°ì„œ ì¹´ë©”ë¼ê°€ ì—´ë¦¬ê²Œ ë¨
const btnScan = document.getElementById("btnScan");
btnScan.addEventListener("click", () => {
  // ì•„ë¬´ ê²ƒë„ í•˜ì§€ ì•ŠìŒ
  // ìŠ¤ìº”ì€ initBarcodeAndroidê°€ ìë™ìœ¼ë¡œ ì‹œì‘í•¨
  alert("ìˆ˜ì •ì—ì„œëŠ” ë°”ì½”ë“œë¥¼ ì´ìš©í•˜ì‹¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
});

let cart=[];

(function initDate(){
  const d=new Date();
  dateEl.value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
})();

function render(){
  cartEl.innerHTML="";
  cart.forEach(i=>{
    cartEl.innerHTML+=`
      <div class="cart-row">
        ${i.productName} / ${fmt(i.qty)} Ã— ${fmt(i.price)}
      </div>`;
  });
}

document.getElementById("btnAdd").onclick=()=>{
  if(!barcodeEl.value) return alert("ë°”ì½”ë“œ ì—†ìŒ");
  cart=[{
    barcode:barcodeEl.value,
    productName:nameEl.value,
    price:Number(priceEl.value),
    qty:Number(qtyEl.value),
    memo:memoEl.value
  }];
  render();
};

if(editMode && editId){
  titleEl.textContent="ë‚©í’ˆ ìˆ˜ì •";
  const list=JSON.parse(localStorage.getItem("sales_list")||"[]");
  const item=list.find(i=>i.id===editId);
  if(item){
    dateEl.value=item.saleDate;
    partnerEl.value=item.partner;
    barcodeEl.value=item.barcode;
    nameEl.value=item.productName;
    priceEl.value = fmt(item.price);
    qtyEl.value = fmt(item.qty);
    stockAmountEl.value = fmt(item.price * item.qty);
    memoEl.value=item.memo||"";
    cart=[{
      barcode:item.barcode,
      productName:item.productName,
      price:item.price,
      qty:item.qty,
      memo:item.memo||""
    }];
    render();
    // ============================
    // âœ… ë‚©í’ˆ ìˆ˜ì • í™”ë©´: ìƒí’ˆ ì´ë¯¸ì§€ í‘œì‹œ
    // ============================

    // 1) ëŒ€í‘œ ì´ë¯¸ì§€ ë§µ
    const imageMap = JSON.parse(
      localStorage.getItem("product_image_map") || "{}"
    );

    // 2) ë§¤ì… ë‚´ì—­ì—ì„œ ì´ë¯¸ì§€ ì°¾ê¸°
    function findPurchaseImage(barcode){
      const purchases = JSON.parse(
        localStorage.getItem("purchase_list") || "[]"
      );
      const found = purchases.find(p => p.barcode === barcode && p.image);
      return found ? found.image : null;
    }

    // 3) ì´ë¯¸ì§€ ê²°ì • (ìš°ì„ ìˆœìœ„)
    const img =
      imageMap[item.barcode] ||
      findPurchaseImage(item.barcode) ||
      null;

    // 4) í™”ë©´ì— í‘œì‹œ
    if (img) {
      const imgBox = document.getElementById("image-box");
      const imgEl  = document.getElementById("image-preview");

      imgEl.src = img;
      imgBox.style.display = "block";
    }
  }
}

document.getElementById("btnSave").onclick=()=>{
  const price = Number(uncomma(priceEl.value));
  const qty   = Number(uncomma(qtyEl.value));
  const total = price * qty;
  let list=JSON.parse(localStorage.getItem("sales_list")||"[]");

  // âœ… ìˆ˜ì •/ì €ì¥ ì‹œ cartë¥¼ input ê°’ìœ¼ë¡œ ê°•ì œ ë™ê¸°í™”
  cart = [{
    barcode: barcodeEl.value,
    productName: nameEl.value,
    price: Number(uncomma(priceEl.value)),
    qty: Number(uncomma(qtyEl.value)),
    total,
    memo: memoEl.value
  }];

  if(editMode){
    list=list.map(i=>i.id===editId?{
      ...i,
      saleDate:dateEl.value,
      partner:partnerEl.value,
      ...cart[0],
      updatedAt:new Date().toISOString()
    }:i);
  }else{
    list.push({
      id:"s_"+Date.now(),
      saleDate:dateEl.value,
      partner:partnerEl.value,
      ...cart[0],
      createdAt:new Date().toISOString()
    });
  }

  localStorage.setItem("sales_list",JSON.stringify(list));
  alert(editMode?"ë‚©í’ˆ ìˆ˜ì • ì™„ë£Œ":"ë‚©í’ˆ ë“±ë¡ ì™„ë£Œ");
  location.href="purchase_list.html";
};
</script>
<script>
const ua = navigator.userAgent;
const isIOS =
  /iPhone|iPad|iPod/i.test(ua) ||
  (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);

if (isIOS) {
  alert("ì•„ì´í°ì€ ë°”ì½”ë“œ ìŠ¤ìº”ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
} else {
  const script = document.createElement("script");
  script.src = "static/js/barcode_android.js?v=" + Date.now();
  script.onload = () => {
    if (window.initBarcodeAndroid) {
      window.initBarcodeAndroid({
        onDetected(code){
          barcodeEl.value = code;
        }
      });
    }
  };
  document.body.appendChild(script);
}
</script>
<!-- scanning script ends -->
<!-- ğŸ–¼ ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
<div id="img-modal" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  justify-content:center;
  align-items:center;
  z-index:9999;
">
  <img id="img-modal-view" style="
    max-width:90%;
    max-height:90%;
    border-radius:12px;
    background:#fff;
  ">
</div>
<script>
// =========================
// ğŸ–¼ ì´ë¯¸ì§€ í´ë¦­ â†’ í¬ê²Œ ë³´ê¸°
// ìˆ˜ì • í™”ë©´ì˜ ì´ë¯¸ì§€ ë°•ìŠ¤ì—ì„œ ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ í¬ê²Œ ë³´ì—¬ì£¼ê³ , ë°°ê²½ì„ í´ë¦­í•˜ë©´ ë‹«ìŠµë‹ˆë‹¤.
document.addEventListener("click", (e) => {
  // sales ìˆ˜ì • í™”ë©´ì—ì„œ ì´ë¯¸ì§€ ë°•ìŠ¤ ë‚´ë¶€ ì´ë¯¸ì§€ë§Œ ëŒ€ìƒìœ¼ë¡œ í•¨
  const img = e.target.closest("#image-box img");
  if (!img) return;
  const src = img.dataset.img || img.src;
  if (!src) return;
  const modal = document.getElementById("img-modal");
  const view  = document.getElementById("img-modal-view");
  view.src = src;
  modal.style.display = "flex";
});
// âŒ ëª¨ë‹¬ í´ë¦­ â†’ ë‹«ê¸°
document.getElementById("img-modal").addEventListener("click", () => {
  document.getElementById("img-modal").style.display = "none";
});
</script>
</body>
</html>
